name: Robot Framework Tests con Docker # Nombre visible en Actions

on:
  repository_dispatch:
    types: [ run-tests ]      # Las pruebas son ejecutadas posterior al despliegue
  
  workflow_dispatch:
    inputs:
      base_url:
        description: "URL del entorno a probar"       # Se puede ejecutar las pruebas a demanda
        required: true
        default: "https://website-app-psi.vercel.app"

permissions:
  contents: write

jobs:
  robot-tests:      # ID del job
    runs-on: ubuntu-latest      # GitHub crea una VM

    steps:
    - name: Checkout repository     # Paso 1: Descarga el código en la VM
      uses: actions/checkout@v4
    
    - name: Build Robot Framework Docker image    # Paso 2: Build de la imagen Docker con Robot Framework
      run: docker build -t robot-tests .
    
    - name: Run Robot Framework tests      # Paso 3: Ejecutar pruebas dentro del contenedor
      run: |
        BASE_URL="${{ github.event.client_payload.base_url || github.event.inputs.base_url }}"

        echo "Running tests against: $BASE_URL"

        docker run --rm \
          --shm-size=2g \
          -e BASE_URL=$BASE_URL \
          -v ${{ github.workspace }}/results:/robot/results \
          -v ${{ github.workspace }}/docs:/robot/docs \
          robot-tests

    - name: Upload Robot Framework results    # Paso 4: Aunque los tests fallen se sube los reportes
      if: always()      # Paso 4.1: Los archivos (artefactos) que se encuentren en la carpeta results se suben
      uses: actions/upload-artifact@v4
      with:
        name: robot-results
        path: results/

    - name: Publish Robot Framework report to GitHub Pages    # Paso 5: Se publica el reporte en GitHub Pages
      run: |
        if [ -d "docs" ] && [ "$(ls -A docs)" ]; then
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add docs
          
          # Solo hacer commit y push si hay cambios
          if git diff --staged --quiet; then
            echo "ℹ️ No hay cambios en los reportes"
          else
            git commit -m "Actualizacion: Reporte de Robot Framework"
            git push
            echo "✅ Reportes publicados en GitHub Pages"
          fi
        else
          echo "⚠️ La carpeta docs/ está vacía o no existe"
          exit 1
        fi