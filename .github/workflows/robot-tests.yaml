name: Robot Framework Tests con Docker # Nombre visible en Actions

on:
  repository_dispatch:
    types: [ run-tests ]      # Las pruebas son ejecutadas posterior al despliegue
  
  workflow_dispatch:
    inputs:
      base_url:
        description: "URL del entorno a probar"       # Se puede ejecutar las pruebas a demanda
        required: true
        default: "https://website-app-psi.vercel.app"

permissions:
  contents: write

jobs:
  robot-tests:  # ID del job
    runs-on: ubuntu-latest  # GitHub crea una VM

    steps:
    - name: Checkout repository   # Paso 1: Descarga el cÃ³digo en la VM
      uses: actions/checkout@v4
    
    # ðŸ”¹ Build de la imagen Docker con Robot Framework
    - name: Build Robot Framework Docker image
      run: docker build -t robot-tests .
    
    # ðŸ”¹ Ejecutar pruebas dentro del contenedor
    - name: Run Robot Framework tests
      run: |
        BASE_URL="${{ github.event.client_payload.base_url || github.event.inputs.base_url }}"

        echo "Running tests against: $BASE_URL"

        docker run --rm \
          -e BASE_URL=$BASE_URL \
          -v ${{ github.workspace }}/results:/robot/results \
          robot-tests

    - name: Upload Robot Framework results    # Paso 6: Aunque los tests fallen se sube los reportes
      if: always()      # Paso 6.1: Los archivos (artefactos) que se encuentren en la carpeta results se suben
      uses: actions/upload-artifact@v4
      with:
        name: robot-results
        path: results/

    - name: Publish Robot Framework report to GitHub Pages    # Paso 7: Se publica el reporte en GitHub Pages
      if: always()
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add docs
        git commit -m "Actualizacion: Reporte de Robot Framework" || echo "Sin ningun cambio"
        git push